# 実装タスク計画 (tasks.md)

## フェーズ概要
- **フェーズ1: Walking Skeleton**  
  最小構成で動画アップロードから解析結果表示までを通す  
  → Issue #1-4
- **フェーズ2: 自動化・効率化**  
  並列ワーカー、キャッシュ、システムリソース情報取得などを追加  
  → Issue #5-7
- **フェーズ3: 堅牢化・運用性強化**  
  CLI、UI拡張、設定・運用周りを整備  
  → Issue #8-9

---

## 依存関係マップ
```
#1 -> #2 -> #3 -> #4 -> #5 -> #8
#3 -> #6
#3 -> #7
#3 -> #9
```

---

## Issue アウトライン表

### Issue #1: FastAPI 骨格の実装
- **概要**: FastAPIアプリを作成し、静的UI・APIの基盤を整備  
- **依存**: ー  
- **担当**: backend  
- **AC**:
  - `/healthz` が200を返す
  - `/static` 配下のファイルが返せる
  - 設定値を環境変数/YAMLから読み込める
  - JobManagerのスタブを用意

---

### Issue #2: 動画アップロードAPI
- **概要**: 動画ファイルを受け取りローカルに保存、job_idを返す  
- **依存**: #1  
- **担当**: backend  
- **AC**:
  - `POST /api/jobs` が mp4/mov/avi を受け取り安全なファイル名で保存
  - JSONに `{job_id, status}` を返す
  - 不正形式は 400
  - 保存先ディレクトリが自動生成される

---

### Issue #3: 解析パイプラインとAPI
- **概要**: OpenVINO推論・追跡・速度計算・結果出力を行う  
- **依存**: #2  
- **担当**: backend  
- **AC**:
  - ジョブが非同期実行される
  - OpenVINOでYOLOv8 IRモデルを推論できる
  - Tracker, Smoothing, Metrics, Overlay, Exportが通る
  - `/api/jobs/{id}/results` がCSV/JSON/動画のURLを返す
  - 失敗時に `FAILED` を返す

---

### Issue #4: フロントエンドでの結果表示
- **概要**: UIから動画アップロード・解析実行・結果再生を可能にする  
- **依存**: #3  
- **担当**: frontend  
- **AC**:
  - ユーザーが動画を選び解析を開始できる
  - 解析完了後、オーバーレイ動画と速度統計が表示される
  - Canvasに `/trajectory.json` の軌跡が動画再生に同期して描画される
  - デバイス選択UIあり
  - 解析中は進捗表示（WS/SSE）

---

### Issue #5: 並列ジョブ管理 & ワーカー制御
- **概要**: asyncio.Queueベースでワーカー並列度を制御  
- **依存**: #4  
- **担当**: backend  
- **AC**:
  - CPU/GPU/NPUごとの最大ワーカー数制御
  - キューに投入されたジョブが順次処理される
  - 進捗が WebSocket で通知される
  - ジョブキャンセルに対応する

---

### Issue #6: システムリソース使用率API
- **概要**: CPU/GPU/NPU使用率を返すAPI  
- **依存**: #3  
- **担当**: backend  
- **AC**:
  - `GET /api/system-usage` がリソース使用率を返す
  - 未対応デバイスは0を返す
  - 処理が1秒以内に完了する

---

### Issue #7: 結果キャッシュ
- **概要**: 同一動画に対する再解析を避けるキャッシュ機能  
- **依存**: #3  
- **担当**: backend  
- **AC**:
  - 入力動画IDごとに結果を保存
  - 再解析時はキャッシュヒットで即時返却
  - `force_reanalyze` オプションあり

---

### Issue #8: UI拡張（ジョブ一覧/管理）
- **概要**: フロントにジョブ一覧と再生・削除機能を追加  
- **依存**: #5  
- **担当**: frontend  
- **AC**:
  - ジョブ一覧が表示できる
  - 解析済み動画・CSV/JSONのリンクを表示
  - 削除ボタンで `DELETE /api/jobs/{id}` が動作する

---

### Issue #9: CLI インターフェース
- **概要**: コマンドラインで動画解析・結果出力を可能にする  
- **依存**: #3  
- **担当**: infra  
- **AC**:
  - `golftrack analyze video.mp4` で解析
  - `--device` でCPU/GPU/NPU切替
  - `--export` でCSV/JSON/MP4保存
  - ヘルプ・エラー対応
